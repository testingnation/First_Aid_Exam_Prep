<!DOCTYPE html>
<html lang="mk">
<head>
  <meta charset="UTF-8">
  <title>First Aid Exam Prep</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background: #f9f9f9; }
    .hidden { display: none; }
    .question { font-size: 1.2em; margin-bottom: 15px; }
    .choices label { display: block; margin: 8px 0; cursor: pointer; }
    button { padding: 10px 20px; margin-top: 15px; font-size: 16px; }
    #timer, #progress { font-weight: bold; margin-bottom: 20px; }
  </style>
</head>
<body>

  <!-- Welcome Screen -->
  <div id="welcome-screen">
    <h1>Добредојдовте во Првa Помош Тест</h1>
    <p>Овој сертификат е задолжителен за добивање возачка дозвола во Северна Македонија и Ви овозможува да бидете подготвени за итни ситуации на патот. Тестот е базиран на официјалната банка на прашања на Црвениот Крст на Северна Македонија, осигурувајќи усогласеност со националните стандарди.</p>
    <p>Секое прашање е можност да учите, вежбате и да станете покомпетентни – останете фокусирани и верувајте во себе!</p>
    <h3>Инструкции за тестот:</h3>
    <ul>
      <li>Потребно е 80% за полагање (12 од 15 прашања).</li>
      <li>Времетраење: 60 минути од моментот кога ќе започнете.</li>
      <li>Прогрес-бар покажува колку прашања сте одговориле.</li>
      <li>Кога ќе завршите, кликнете Submit за да се пресмета тестот.</li>
      <li>Резултатот се прикажува веднаш како Pass/Fail со број на точни одговори (на пример, 14 од 15).</li>
    </ul>
    <p><strong>Совет:</strong> Одвојте внимание, останете смирени и верувајте во вашето знаење – секое прашање е шанса да научите и да се подготвите!</p>
    <button onclick="startTest()">Започни го тестот</button>
  </div>

  <!-- Test Screen -->
  <div id="test-screen" class="hidden">
    <div id="timer"></div>
    <div id="progress"></div>
    <div id="question-container"></div>
    <button id="confirm-btn" onclick="confirmAnswer()">Потврди го одговорот</button>
  </div>

  <!-- Results Screen -->
  <div id="results-screen" class="hidden">
    <h2>Резултати</h2>
    <p id="score"></p>
  </div>

  <!-- Review Screen -->
  <div id="review-screen" class="hidden">
    <h2>Преглед на неточни одговори</h2>
    <div id="review-content"></div>
    <button onclick="location.reload()">Започни повторно</button>
  </div>

<script>
let questions = [];
let selectedQuestions = [];
let currentQuestionIndex = 0;
let score = 0;
let userAnswers = [];
let timerInterval;

const groupRatios = {
  "FAB": 2, "S&A": 1, "A&P": 1, "AB&": 2,
  "B&S": 4, "C&R": 2, "I&S": 1, "C&A": 0,
  "WC&": 1, "SC&": 1
};

async function startTest() {
  document.getElementById("welcome-screen").classList.add("hidden");
  document.getElementById("test-screen").classList.remove("hidden");

  try {
    const response = await fetch("first_aid_questions.json");
    questions = await response.json();

    const grouped = {};
    for (let q of questions) {
      const group = q.group || "OTHER";
      if (!grouped[group]) grouped[group] = [];
      grouped[group].push(q);
    }

    for (let [group, count] of Object.entries(groupRatios)) {
      if (grouped[group]) {
        const shuffled = grouped[group].sort(() => 0.5 - Math.random());
        selectedQuestions.push(...shuffled.slice(0, count));
      }
    }

    selectedQuestions = selectedQuestions.sort(() => 0.5 - Math.random());
    document.getElementById("progress").textContent = `Одговорени прашања: 0 / ${selectedQuestions.length}`;
    startTimer(60 * 60);
    showQuestion();
  } catch (error) {
    alert("Грешка при вчитување на прашањата.");
    console.error(error);
  }
}

function showQuestion() {
  const q = selectedQuestions[currentQuestionIndex];
  const container = document.getElementById("question-container");
  const shuffledChoices = [...q.choices].sort(() => 0.5 - Math.random());

  container.innerHTML = `
    <div class="question">${q.question}</div>
    <div class="choices">
      ${shuffledChoices.map(choice => `
        <label>
          <input type="radio" name="choice" value="${choice}"> ${choice}
        </label>
      `).join("")}
    </div>
  `;
}

function confirmAnswer() {
  const selected = document.querySelector('input[name="choice"]:checked');
  if (!selected) {
    alert("Ве молиме изберете одговор.");
    return;
  }

  const userAnswer = selected.value;
  userAnswers.push(userAnswer);

  const correctAnswer = selectedQuestions[currentQuestionIndex].answer;
  if (userAnswer === correctAnswer) score++;

  currentQuestionIndex++;
  document.getElementById("progress").textContent = `Одговорени прашања: ${currentQuestionIndex} / ${selectedQuestions.length}`;

  if (currentQuestionIndex < selectedQuestions.length) {
    showQuestion();
  } else {
    finishTest();
  }
}

function finishTest() {
  clearInterval(timerInterval);
  document.getElementById("test-screen").classList.add("hidden");
  document.getElementById("results-screen").classList.remove("hidden");

  const passScore = Math.ceil(selectedQuestions.length * 0.8);
  const resultText = score >= passScore
    ? `✅ Честитки! Положивте со ${score} од ${selectedQuestions.length} точни одговори.`
    : `❌ Не положивте. Вашиот резултат е ${score} од ${selectedQuestions.length}. Обидете се повторно.`;

  document.getElementById("score").innerHTML = resultText;

  const reviewDiv = document.getElementById("review-content");
  const incorrectOnly = selectedQuestions.map((q, i) => {
    return {
      index: i + 1,
      question: q.question,
      correct: q.answer,
      user: userAnswers[i],
      isCorrect: userAnswers[i] === q.answer
    };
  }).filter(q => !q.isCorrect);

  if (incorrectOnly.length > 0) {
    document.getElementById("review-screen").classList.remove("hidden");
    reviewDiv.innerHTML = incorrectOnly.map(q => `
      <div class="incorrect">
        <p><b>Прашање ${q.index}:</b> ${q.question}</p>
        <p>Ваш одговор: <span style="color:red;">${q.user || "Неодговорено"}</span></p>
        <p>Точен одговор: <span style="color:green;"><b>${q.correct}</b></span></p>
        <hr>
      </div>
    `).join("");
  }
}

function startTimer(duration) {
  let time = duration;
  const timerDisplay = document.getElementById("timer");

  timerInterval = setInterval(() => {
    const minutes = Math.floor(time / 60);
    const seconds = time % 60;
    timerDisplay.textContent = `Преостанато време: ${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;
    if (--time < 0) {
      clearInterval(timerInterval);
      finishTest();
    }
  }, 1000);
}
</script>
</body>
</html>
